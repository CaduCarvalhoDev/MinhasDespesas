@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject IJSRuntime JSRuntime

<div class="row bg-light p-3 mb-4 rounded border">
    
    <div class="col-md-3">
        <label for="dataInicio" class="form-label">Data Início</label>
        <InputDate id="dataInicio" class="form-control" @bind-Value="filtroDataInicio" />
    </div>

    <div class="col-md-3">
        <label for="dataFim" class="form-label">Data Fim</label>
        <InputDate id="dataFim" class="form-control" @bind-Value="filtroDataFim" />
    </div>

    <div class="col-md-3">
        <label for="categoria" class="form-label">Categoria</label>
        <InputSelect id="categoria" class="form-select" @bind-Value="filtroCategoriaId">
            <option value="0">-- Todas as Categorias --</option>
            @if (categorias != null)
            {
                @foreach (var categoria in categorias)
                {
                    <option value="@categoria.Id">@categoria.Nome</option>
                }
            }
        </InputSelect>
    </div>

    <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-primary me-2" @onclick="HandleFiltrar">Filtrar</button>
        <button class="btn btn-secondary" @onclick="HandleLimparFiltros">Limpar</button>
    </div>

</div>


@if (despesasFiltradas == null)
{
    <p><em>Carregando histórico...</em></p>
}
else if (despesasFiltradas.Count == 0)
{
    <p><em>Nenhuma despesa encontrada para os filtros selecionados.</em></p>
}
else
{
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th class="text-end">Valor (R$)</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var despesa in despesasFiltradas)
            {
                <tr>
                    <td>@despesa.Data.ToShortDateString()</td>
                    <td>@despesa.Descricao</td>
                    <td>@despesa.Categoria?.Nome</td>
                    <td class="text-end">@despesa.Valor.ToString("C")</td>
                    <td>
                        <button class="btn btn-danger btn-sm"
                                @onclick="() => HandleExcluir(despesa.Id)">
                            Excluir
                        </button>
                    </td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr class="fw-bold">
                <td colspan="3" class="text-end">Total Filtrado:</td>
                <td class="text-end">@totalFiltrado.ToString("C")</td>
            </tr>
        </tfoot>
    </table>
}


@code {
    // --- Listas de Dados ---
    private List<Categoria>? categorias;      // Para o dropdown de filtro
    private List<Despesa>? despesasFiltradas; // Para a tabela

    // --- Campos de Filtro ---
    private DateTime? filtroDataInicio;
    private DateTime? filtroDataFim;
    private int filtroCategoriaId = 0; // 0 = "Todas"

    // --- Resumo ---
    private decimal totalFiltrado = 0;


    // 1. Quando o componente é carregado
    protected override async Task OnInitializedAsync()
    {
        // Carrega as categorias para o dropdown de filtro
        categorias = await DbContext.Categorias.OrderBy(c => c.Nome).ToListAsync();
        
        // Carrega todas as despesas na primeira vez
        await CarregarDespesas();
    }

    // 2. O Método Principal (O "Motor" do Filtro)
    private async Task CarregarDespesas()
    {
        // Começa com a consulta base (IQueryable)
        var query = DbContext.Despesas
                             .Include(d => d.Categoria)
                             .AsQueryable(); // AsQueryable é importante para construir a query

        // Adiciona os filtros (LINQ)
        if (filtroDataInicio.HasValue)
        {
            query = query.Where(d => d.Data.Date >= filtroDataInicio.Value.Date);
        }

        if (filtroDataFim.HasValue)
        {
            query = query.Where(d => d.Data.Date <= filtroDataFim.Value.Date);
        }

        if (filtroCategoriaId > 0)
        {
            query = query.Where(d => d.CategoriaId == filtroCategoriaId);
        }

        // Executa a consulta no banco (ToListAsync)
        despesasFiltradas = await query.OrderByDescending(d => d.Data).ToListAsync();

        // Calcula o total
        totalFiltrado = despesasFiltradas.Sum(d => d.Valor);
    }

    // 3. O que acontece quando clica em "Filtrar"
    private async Task HandleFiltrar()
    {
        await CarregarDespesas();
    }

    // 4. O que acontece quando clica em "Limpar"
    private async Task HandleLimparFiltros()
    {
        filtroDataInicio = null;
        filtroDataFim = null;
        filtroCategoriaId = 0;
        
        await CarregarDespesas();
    }
    
    // 5. O que acontece quando clica em "Excluir"
    private async Task HandleExcluir(int despesaId)
    {
        // 1. Pede confirmação ao usuário
        var confirmou = await JSRuntime.InvokeAsync<bool>("confirm", "Tem certeza que deseja excluir esta despesa?");

        if (!confirmou)
        {
            return; // Usuário clicou em "Cancelar"
        }

        try
        {
            // 2. Encontra a despesa no banco
            var despesaParaExcluir = await DbContext.Despesas.FindAsync(despesaId);

            if (despesaParaExcluir != null)
            {
                // 3. Remove do DbContext
                DbContext.Despesas.Remove(despesaParaExcluir);
                
                // 4. Salva a mudança no banco
                await DbContext.SaveChangesAsync();
                
                // 5. Recarrega a lista (que chama CarregarDespesas)
                await HandleFiltrar(); 
            }
        }
        catch (Exception ex)
        {
            // (Opcional) Mostrar um erro para o usuário
            Console.WriteLine($"Erro ao excluir: {ex.Message}");
        }
    }
}