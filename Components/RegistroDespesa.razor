@using Microsoft.EntityFrameworkCore

@* Injeta o "serviço" do DbContext para que possamos usar o banco de dados *@
@inject ApplicationDbContext DbContext
@inject IJSRuntime JSRuntime

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card text-white bg-danger mb-3">
            <div class="card-header">Total Gasto (Mês Atual)</div>
            <div class="card-body">
                <h4 class="card-title">@totalGastoMes.ToString("C")</h4>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card text-white bg-info mb-3">
            <div class="card-header">Principal Categoria (Geral)</div>
            <div class="card-body">
                <h4 class="card-title">@categoriaMaisCara</h4>
            </div>
        </div>
    </div>
</div>

<div class="row">

        <div class="col-md-5">
            <h3>Registrar Nova Despesa</h3>
            @if (categorias == null)
            {
                <p><em>Carregando categorias...</em></p>
            }
            else
            {
                <EditForm Model="novaDespesa" OnValidSubmit="HandleSubmit" FormName="RegistroDespesa">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="mb-3">
                        <label for="descricao" class="form-label">Descrição</label>
                        <InputText id="descricao" class="form-control" @bind-Value="novaDespesa.Descricao" />
                    </div>

                    <div class="mb-3">
                        <label for="valor" class="form-label">Valor (R$)</label>
                        <InputNumber id="valor" class="form-control" @bind-Value="novaDespesa.Valor" />
                    </div>

                    <div class="mb-3">
                        <label for="data" class="form-label">Data</label>
                        <InputDate id="data" class="form-control" @bind-Value="novaDespesa.Data" />
                    </div>

                    <div class="mb-3">
                        <label for="categoria" class="form-label">Categoria</label>
                        <InputSelect id="categoria" class="form-select" @bind-Value="novaDespesa.CategoriaId">
                            <option value="0">-- Selecione uma categoria --</option>
                            @foreach (var categoria in categorias)
                            {
                                <option value="@categoria.Id">@categoria.Nome</option>
                            }
                        </InputSelect>
                    </div>

                    <button type="submit" class="btn btn-primary">Salvar Despesa</button>
                </EditForm>
            }
        </div>

        <div class="col-md-7">
            <h3>Gastos por Categoria</h3>

            <div style="position: relative; max-height: 400px;">
                <canvas id="graficoPizza"></canvas>
            </div>

        </div>

    </div>
    <hr class="my-4">

    <h3>Despesas Recentes</h3>

    @if (despesas == null)
    {
        <p><em>Carregando despesas...</em></p>
    }
    else if (despesas.Count == 0)
    {
        <p><em>Nenhuma despesa registrada ainda.</em></p>
    }
    else
    {
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Descrição</th>
                    <th>Categoria</th>
                    <th class="text-end">Valor (R$)</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var despesa in despesas)
                {
                    <tr>
                        <td>@despesa.Data.ToShortDateString()</td>
                        <td>@despesa.Descricao</td>
                        <td>@despesa.Categoria?.Nome</td> <td class="text-end">@despesa.Valor.ToString("C")</td> </tr>
                }
            </tbody>
        </table>
    }



@code {
    // ---- Propriedades ----
    private Despesa novaDespesa = new Despesa();
    private List<Categoria>? categorias;
    private List<Despesa>? despesas;
    
    private decimal totalGastoMes = 0;
    private string categoriaMaisCara = "N/D";

    // ---- Métodos ----

    // 1. Quando o componente é carregado
    protected override async Task OnInitializedAsync()
    {
        // Esta parte roda na pré-renderização (sem JS)
        novaDespesa.Data = DateTime.Today;
        categorias = await DbContext.Categorias.ToListAsync();
        await CarregarDespesas(); // Agora só carrega os dados
    }

    // ---- NOVO MÉTODO DE CICLO DE VIDA ----
    // 2. Roda DEPOIS que o componente foi renderizado no navegador
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // "firstRender" é true na primeira vez que o componente aparece
        if (firstRender)
        {
            // Agora que o <canvas> existe, podemos desenhar o gráfico inicial
            await DesenharGrafico();
        }
    }

    // 3. Método para carregar as despesas
    private async Task CarregarDespesas()
    {
        despesas = await DbContext.Despesas
                                  .Include(d => d.Categoria)
                                  .OrderByDescending(d => d.Data)
                                  .ToListAsync();
        
        // Calcula os resumos (para os cards)
        CalcularResumos();
        
        // --- A LINHA QUE DAVA ERRO FOI REMOVIDA DAQUI ---
    }

    // 4. Método para calcular os resumos (para os cards)
    private void CalcularResumos()
    {
        if (despesas == null || despesas.Count == 0)
        {
            totalGastoMes = 0;
            categoriaMaisCara = "N/D";
            return;
        }

        var hoje = DateTime.Today;
        totalGastoMes = despesas
            .Where(d => d.Data.Year == hoje.Year && d.Data.Month == hoje.Month)
            .Sum(d => d.Valor);

        var categoriaAgrupada = despesas
            .GroupBy(d => d.Categoria?.Nome) 
            .Select(grupo => new 
            {
                Nome = grupo.Key ?? "Sem Categoria",
                Total = grupo.Sum(d => d.Valor)
            })
            .OrderByDescending(g => g.Total)
            .FirstOrDefault();

        if (categoriaAgrupada != null)
        {
            categoriaMaisCara = $"{categoriaAgrupada.Nome} ({categoriaAgrupada.Total:C})";
        }
    }

    // 5. Método para preparar os dados e chamar o JS
    private async Task DesenharGrafico()
    {
        if (despesas == null || despesas.Count == 0)
            return; // Não desenha se não tiver dados
        
        var dadosGrafico = despesas
            .GroupBy(d => d.Categoria?.Nome)
            .Select(grupo => new 
            {
                Label = grupo.Key ?? "Sem Categoria",
                Data = grupo.Sum(d => d.Valor)
            })
            .ToList();

        var labels = dadosGrafico.Select(d => d.Label).ToList();
        var data = dadosGrafico.Select(d => d.Data).ToList();

        // Esta chamada agora é segura (feita de OnAfterRenderAsync ou HandleSubmit)
        await JSRuntime.InvokeVoidAsync("desenharGraficoPizza", labels, data);
    }


    // 6. Quando o formulário é enviado
    private async Task HandleSubmit()
    {
        try
        {
            DbContext.Despesas.Add(novaDespesa);
            await DbContext.SaveChangesAsync();

            novaDespesa = new Despesa();
            novaDespesa.Data = DateTime.Today;
            
            // 1. Recarrega os dados (listas e cards)
            await CarregarDespesas(); 

            // ---- LINHA ADICIONADA ----
            // 2. Redesenha o gráfico com os novos dados
            await DesenharGrafico();

            // ---- LINHA ADICIONADA ----
            // 3. Força a UI a atualizar (cards, lista)
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }
}